<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Team vs Pac-Man - Online Multiplayer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
        }

        .main-container {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 900px;
            width: 100%;
        }

        h1 {
            text-align: center;
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .menu {
            text-align: center;
            padding: 20px;
        }

        .menu input {
            width: 100%;
            max-width: 300px;
            padding: 12px;
            margin: 10px 0;
            font-size: 1.1em;
            border: 2px solid #ffd700;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            text-align: center;
        }

        .menu input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 10px #ffd700;
        }

        .ghost-selection {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .ghost-option {
            cursor: pointer;
            padding: 15px;
            border: 3px solid transparent;
            border-radius: 10px;
            transition: all 0.3s;
            background: rgba(255, 255, 255, 0.1);
        }

        .ghost-option:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.2);
        }

        .ghost-option.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }

        .ghost-icon {
            font-size: 3em;
            display: block;
        }

        .ghost-name {
            margin-top: 5px;
            font-size: 0.9em;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        button {
            padding: 12px 30px;
            font-size: 1.1em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
        }

        .btn-create {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }

        .btn-join {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #gameArea {
            display: none;
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
        }

        .room-display {
            font-size: 1.2em;
            color: #ffd700;
            font-weight: bold;
        }

        .players-count {
            color: #4fc3f7;
        }

        canvas {
            display: block;
            margin: 0 auto;
            border: 3px solid #ffd700;
            border-radius: 10px;
            background: #000;
        }

        .controls-help {
            text-align: center;
            margin-top: 15px;
            color: #aaa;
        }

        .status-message {
            text-align: center;
            padding: 20px;
            font-size: 1.3em;
            color: #4fc3f7;
        }

        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .connected {
            background: #4caf50;
        }

        .disconnected {
            background: #f44336;
        }

        .score-board {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .winner-announcement {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            font-size: 2em;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <h1>üëª Ghost Team vs Pac-Man üü°</h1>
        
        <div id="menu" class="menu">
            <div>
                <input type="text" id="playerName" placeholder="Enter your name" maxlength="15">
            </div>
            
            <div class="ghost-selection">
                <div class="ghost-option" data-color="red">
                    <span class="ghost-icon">üëπ</span>
                    <div class="ghost-name">Blinky</div>
                </div>
                <div class="ghost-option" data-color="pink">
                    <span class="ghost-icon">üë∫</span>
                    <div class="ghost-name">Pinky</div>
                </div>
                <div class="ghost-option" data-color="cyan">
                    <span class="ghost-icon">üëª</span>
                    <div class="ghost-name">Inky</div>
                </div>
                <div class="ghost-option" data-color="orange">
                    <span class="ghost-icon">üéÉ</span>
                    <div class="ghost-name">Clyde</div>
                </div>
            </div>
            
            <div class="button-group">
                <button class="btn-create" id="createRoomBtn">Create Room</button>
                <button class="btn-join" id="joinRoomBtn">Join Room</button>
            </div>
            
            <div id="joinInput" style="display: none;">
                <input type="text" id="roomCode" placeholder="Enter Room Code" maxlength="6" style="text-transform: uppercase;">
                <button id="joinBtn">Join</button>
            </div>
            
            <div class="controls-help">
                <p>üéÆ Use Arrow Keys or WASD to move</p>
                <p>üëª Team up with other ghosts to catch Pac-Man!</p>
                <p>üèÜ Ghost who catches Pac-Man gets 100 points!</p>
            </div>
        </div>
        
        <div id="gameArea">
            <div class="game-info">
                <div class="room-display">Room: <span id="roomDisplay"></span></div>
                <div class="players-count">Players: <span id="playersCount">1</span></div>
            </div>
            
            <canvas id="gameCanvas"></canvas>
            
            <div class="score-board" id="scoreBoard"></div>
            
            <div class="controls-help">
                Use Arrow Keys or WASD to move your ghost
            </div>
        </div>
        
        <div id="waiting" class="status-message" style="display: none;">
            Waiting for players... Share room code: <span id="waitingRoomCode"></span>
        </div>
    </div>
    
    <div class="winner-announcement" id="winnerAnnouncement"></div>

    <!-- Supabase for real-time multiplayer -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        // Initialize Supabase (Free tier - no credit card required)
        // Get your free keys at: https://supabase.com
        const SUPABASE_URL = 'https://xlpqxxhqwqkfbroimnkp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhscHF4eGhxd3FrZmJyb2ltbmtwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYzNDUxMjMsImV4cCI6MjA1MTkyMTEyM30.RpJMSpTT5r9MHFY5Z_HPLaKXj5PKxsNJSWYZ4sjKw-s';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        class GhostVsPacmanGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = 600;
                this.canvas.height = 600;
                
                // Game settings
                this.gridSize = 20;
                this.cellSize = 30;
                
                // Player data
                this.playerId = Math.random().toString(36).substr(2, 9);
                this.playerName = '';
                this.playerGhost = null;
                this.roomCode = null;
                this.isHost = false;
                
                // Game state
                this.players = new Map();
                this.pacman = null;
                this.dots = [];
                this.score = {};
                this.gameActive = false;
                this.channel = null;
                
                // Movement
                this.keys = {};
                this.lastMoveTime = 0;
                this.moveDelay = 100; // Smooth movement
                
                this.setupControls();
                this.createMaze();
            }
            
            setupControls() {
                document.addEventListener('keydown', (e) => {
                    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'w', 'a', 's', 'd'].includes(e.key.toLowerCase())) {
                        e.preventDefault();
                        this.keys[e.key.toLowerCase()] = true;
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key.toLowerCase()] = false;
                });
                
                // Ghost selection
                document.querySelectorAll('.ghost-option').forEach(option => {
                    option.addEventListener('click', () => {
                        document.querySelectorAll('.ghost-option').forEach(o => o.classList.remove('selected'));
                        option.classList.add('selected');
                        this.playerGhost = option.dataset.color;
                    });
                });
            }
            
            createMaze() {
                this.maze = [];
                for (let y = 0; y < this.gridSize; y++) {
                    this.maze[y] = [];
                    for (let x = 0; x < this.gridSize; x++) {
                        // Create walls
                        if (x === 0 || x === this.gridSize - 1 || y === 0 || y === this.gridSize - 1) {
                            this.maze[y][x] = 1;
                        } else if ((x % 3 === 0 && y % 4 === 0) || (x % 5 === 2 && y % 3 === 1)) {
                            this.maze[y][x] = 1;
                        } else {
                            this.maze[y][x] = 0;
                        }
                    }
                }
                
                // Create ghost spawn area (center)
                for (let y = 8; y <= 11; y++) {
                    for (let x = 8; x <= 11; x++) {
                        this.maze[y][x] = 0;
                    }
                }
            }
            
            async createRoom() {
                if (!this.validateInput()) return;
                
                this.roomCode = Math.random().toString(36).substr(2, 6).toUpperCase();
                this.isHost = true;
                
                await this.connectToRoom();
            }
            
            showJoinInput() {
                document.getElementById('joinInput').style.display = 'block';
            }
            
            async joinRoom() {
                if (!this.validateInput()) return;
                
                const code = document.getElementById('roomCode').value.toUpperCase();
                if (!code) {
                    alert('Please enter a room code!');
                    return;
                }
                
                this.roomCode = code;
                this.isHost = false;
                
                await this.connectToRoom();
            }
            
            validateInput() {
                this.playerName = document.getElementById('playerName').value.trim();
                
                if (!this.playerName) {
                    alert('Please enter your name!');
                    return false;
                }
                
                if (!this.playerGhost) {
                    alert('Please select a ghost!');
                    return false;
                }
                
                return true;
            }
            
            async connectToRoom() {
                // Subscribe to room channel
                this.channel = supabase.channel(`room-${this.roomCode}`)
                    .on('broadcast', { event: 'player-update' }, (payload) => {
                        this.handlePlayerUpdate(payload.payload);
                    })
                    .on('broadcast', { event: 'pacman-update' }, (payload) => {
                        this.handlePacmanUpdate(payload.payload);
                    })
                    .on('broadcast', { event: 'game-state' }, (payload) => {
                        this.handleGameState(payload.payload);
                    })
                    .on('broadcast', { event: 'dot-eaten' }, (payload) => {
                        this.handleDotEaten(payload.payload);
                    })
                    .on('broadcast', { event: 'ghost-caught-pacman' }, (payload) => {
                        this.handleGhostCaughtPacman(payload.payload);
                    })
                    .subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            // Join the game
                            await this.joinGame();
                        }
                    });
            }
            
            async joinGame() {
                // Add player to game
                const player = {
                    id: this.playerId,
                    name: this.playerName,
                    ghost: this.playerGhost,
                    x: Math.floor(Math.random() * 4) + 8,
                    y: Math.floor(Math.random() * 4) + 8,
                    score: 0
                };
                
                this.players.set(this.playerId, player);
                
                // Broadcast player joined
                await this.channel.send({
                    type: 'broadcast',
                    event: 'player-update',
                    payload: { action: 'join', player }
                });
                
                // Show game area
                document.getElementById('menu').style.display = 'none';
                document.getElementById('gameArea').style.display = 'block';
                document.getElementById('roomDisplay').textContent = this.roomCode;
                
                // If host, initialize Pac-Man after delay
                if (this.isHost) {
                    setTimeout(() => this.initializePacman(), 2000);
                }
                
                // Start game loop
                this.gameActive = true;
                this.gameLoop();
            }
            
            initializePacman() {
                if (!this.isHost) return;
                
                // Create Pac-Man at random position
                this.pacman = {
                    x: 1,
                    y: 1,
                    dx: 1,
                    dy: 0,
                    speed: 0.05,
                    animFrame: 0
                };
                
                // Create dots
                this.dots = [];
                for (let y = 0; y < this.gridSize; y++) {
                    for (let x = 0; x < this.gridSize; x++) {
                        if (this.maze[y][x] === 0 && Math.random() < 0.5) {
                            this.dots.push({ x, y });
                        }
                    }
                }
                
                // Broadcast initial game state
                this.channel.send({
                    type: 'broadcast',
                    event: 'game-state',
                    payload: {
                        pacman: this.pacman,
                        dots: this.dots
                    }
                });
                
                // Start Pac-Man AI
                this.startPacmanAI();
            }
            
            startPacmanAI() {
                if (!this.isHost || !this.pacman) return;
                
                setInterval(() => {
                    if (!this.pacman || !this.gameActive) return;
                    
                    // Move Pac-Man
                    let newX = this.pacman.x + this.pacman.dx * this.pacman.speed;
                    let newY = this.pacman.y + this.pacman.dy * this.pacman.speed;
                    
                    // Check wall collision
                    const gridX = Math.round(newX);
                    const gridY = Math.round(newY);
                    
                    if (this.maze[gridY] && this.maze[gridY][gridX] === 1) {
                        // Change direction
                        const directions = [
                            { dx: 1, dy: 0 },
                            { dx: -1, dy: 0 },
                            { dx: 0, dy: 1 },
                            { dx: 0, dy: -1 }
                        ];
                        
                        // Find valid direction
                        for (let dir of directions.sort(() => Math.random() - 0.5)) {
                            const testX = Math.round(this.pacman.x + dir.dx);
                            const testY = Math.round(this.pacman.y + dir.dy);
                            
                            if (this.maze[testY] && this.maze[testY][testX] === 0) {
                                this.pacman.dx = dir.dx;
                                this.pacman.dy = dir.dy;
                                break;
                            }
                        }
                    } else {
                        this.pacman.x = newX;
                        this.pacman.y = newY;
                        
                        // Random direction change
                        if (Math.random() < 0.1) {
                            const directions = [
                                { dx: 1, dy: 0 },
                                { dx: -1, dy: 0 },
                                { dx: 0, dy: 1 },
                                { dx: 0, dy: -1 }
                            ];
                            
                            const newDir = directions[Math.floor(Math.random() * directions.length)];
                            const testX = Math.round(this.pacman.x + newDir.dx);
                            const testY = Math.round(this.pacman.y + newDir.dy);
                            
                            if (this.maze[testY] && this.maze[testY][testX] === 0) {
                                this.pacman.dx = newDir.dx;
                                this.pacman.dy = newDir.dy;
                            }
                        }
                    }
                    
                    this.pacman.animFrame = (this.pacman.animFrame + 1) % 20;
                    
                    // Check dot collision
                    const pacGridX = Math.round(this.pacman.x);
                    const pacGridY = Math.round(this.pacman.y);
                    
                    const dotIndex = this.dots.findIndex(d => d.x === pacGridX && d.y === pacGridY);
                    if (dotIndex !== -1) {
                        this.dots.splice(dotIndex, 1);
                        
                        this.channel.send({
                            type: 'broadcast',
                            event: 'dot-eaten',
                            payload: { x: pacGridX, y: pacGridY }
                        });
                        
                        // Respawn dots if too few
                        if (this.dots.length < 10) {
                            for (let i = 0; i < 20; i++) {
                                const x = Math.floor(Math.random() * this.gridSize);
                                const y = Math.floor(Math.random() * this.gridSize);
                                if (this.maze[y][x] === 0) {
                                    this.dots.push({ x, y });
                                }
                            }
                        }
                    }
                    
                    // Broadcast Pac-Man position
                    this.channel.send({
                        type: 'broadcast',
                        event: 'pacman-update',
                        payload: this.pacman
                    });
                }, 50);
            }
            
            handlePlayerUpdate(data) {
                if (data.action === 'join' && data.player.id !== this.playerId) {
                    this.players.set(data.player.id, data.player);
                } else if (data.action === 'move' && data.player.id !== this.playerId) {
                    const player = this.players.get(data.player.id);
                    if (player) {
                        player.x = data.player.x;
                        player.y = data.player.y;
                    }
                } else if (data.action === 'leave') {
                    this.players.delete(data.player.id);
                }
                
                document.getElementById('playersCount').textContent = this.players.size;
            }
            
            handlePacmanUpdate(pacman) {
                this.pacman = pacman;
            }
            
            handleGameState(state) {
                this.pacman = state.pacman;
                this.dots = state.dots;
            }
            
            handleDotEaten(data) {
                const index = this.dots.findIndex(d => d.x === data.x && d.y === data.y);
                if (index !== -1) {
                    this.dots.splice(index, 1);
                }
            }
            
            handleGhostCaughtPacman(data) {
                // Update score
                const player = this.players.get(data.playerId);
                if (player) {
                    player.score += 100;
                    
                    // Show winner announcement
                    const announcement = document.getElementById('winnerAnnouncement');
                    announcement.textContent = `${player.name} caught Pac-Man! +100 points!`;
                    announcement.style.display = 'block';
                    
                    setTimeout(() => {
                        announcement.style.display = 'none';
                    }, 3000);
                }
                
                // Reset Pac-Man position
                if (this.pacman) {
                    this.pacman.x = Math.floor(Math.random() * (this.gridSize - 2)) + 1;
                    this.pacman.y = Math.floor(Math.random() * (this.gridSize - 2)) + 1;
                }
            }
            
            update() {
                const now = Date.now();
                if (now - this.lastMoveTime < this.moveDelay) return;
                
                const player = this.players.get(this.playerId);
                if (!player) return;
                
                let dx = 0, dy = 0;
                
                if (this.keys['arrowup'] || this.keys['w']) dy = -1;
                if (this.keys['arrowdown'] || this.keys['s']) dy = 1;
                if (this.keys['arrowleft'] || this.keys['a']) dx = -1;
                if (this.keys['arrowright'] || this.keys['d']) dx = 1;
                
                if (dx !== 0 || dy !== 0) {
                    const newX = player.x + dx;
                    const newY = player.y + dy;
                    
                    // Check wall collision
                    if (this.maze[newY] && this.maze[newY][newX] === 0) {
                        player.x = newX;
                        player.y = newY;
                        this.lastMoveTime = now;
                        
                        // Check if caught Pac-Man
                        if (this.pacman) {
                            const pacX = Math.round(this.pacman.x);
                            const pacY = Math.round(this.pacman.y);
                            
                            if (player.x === pacX && player.y === pacY) {
                                // Caught Pac-Man!
                                this.channel.send({
                                    type: 'broadcast',
                                    event: 'ghost-caught-pacman',
                                    payload: { playerId: this.playerId }
                                });
                                
                                player.score += 100;
                            }
                        }
                        
                        // Broadcast movement
                        this.channel.send({
                            type: 'broadcast',
                            event: 'player-update',
                            payload: { action: 'move', player }
                        });
                    }
                }
            }
            
            render() {
                // Clear canvas
                this.ctx.fillStyle = '#111';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw maze
                this.ctx.fillStyle = '#0f3460';
                for (let y = 0; y < this.gridSize; y++) {
                    for (let x = 0; x < this.gridSize; x++) {
                        if (this.maze[y][x] === 1) {
                            this.ctx.fillRect(
                                x * this.cellSize + 2,
                                y * this.cellSize + 2,
                                this.cellSize - 4,
                                this.cellSize - 4
                            );
                        }
                    }
                }
                
                // Draw dots
                this.ctx.fillStyle = '#fff';
                this.dots.forEach(dot => {
                    this.ctx.beginPath();
                    this.ctx.arc(
                        dot.x * this.cellSize + this.cellSize / 2,
                        dot.y * this.cellSize + this.cellSize / 2,
                        3,
                        0,
                        Math.PI * 2
                    );
                    this.ctx.fill();
                });
                
                // Draw Pac-Man
                if (this.pacman) {
                    this.ctx.fillStyle = '#ffff00';
                    const pacX = this.pacman.x * this.cellSize + this.cellSize / 2;
                    const pacY = this.pacman.y * this.cellSize + this.cellSize / 2;
                    
                    this.ctx.beginPath();
                    
                    // Animated mouth
                    const mouthAngle = Math.abs(Math.sin(this.pacman.animFrame * 0.2)) * 0.4;
                    
                    let startAngle = mouthAngle;
                    let endAngle = Math.PI * 2 - mouthAngle;
                    
                    if (this.pacman.dx < 0) {
                        startAngle = Math.PI + mouthAngle;
                        endAngle = Math.PI - mouthAngle;
                    } else if (this.pacman.dy < 0) {
                        startAngle = Math.PI * 1.5 + mouthAngle;
                        endAngle = Math.PI * 1.5 - mouthAngle;
                    } else if (this.pacman.dy > 0) {
                        startAngle = Math.PI * 0.5 + mouthAngle;
                        endAngle = Math.PI * 0.5 - mouthAngle;
                    }
                    
                    this.ctx.arc(pacX, pacY, this.cellSize / 2 - 3, startAngle, endAngle);
                    this.ctx.lineTo(pacX, pacY);
                    this.ctx.fill();
                }
                
                // Draw ghosts
                this.players.forEach(player => {
                    const colors = {
                        red: '#ff0000',
                        pink: '#ffb8ff',
                        cyan: '#00ffff',
                        orange: '#ffb847'
                    };
                    
                    this.ctx.fillStyle = colors[player.ghost] || '#fff';
                    const ghostX = player.x * this.cellSize + this.cellSize / 2;
                    const ghostY = player.y * this.cellSize + this.cellSize / 2;
                    
                    // Ghost body
                    this.ctx.beginPath();
                    this.ctx.arc(ghostX, ghostY - 3, this.cellSize / 2 - 3, Math.PI, 0);
                    this.ctx.lineTo(ghostX + this.cellSize / 2 - 3, ghostY + this.cellSize / 2 - 5);
                    
                    // Wavy bottom
                    for (let i = 0; i < 4; i++) {
                        const waveX = ghostX + this.cellSize / 2 - 3 - (i * 6);
                        this.ctx.lineTo(waveX, ghostY + this.cellSize / 2 - 5 + Math.sin(Date.now() * 0.01 + i) * 2);
                    }
                    
                    this.ctx.lineTo(ghostX - this.cellSize / 2 + 3, ghostY + this.cellSize / 2 - 5);
                    this.ctx.closePath();
                    this.ctx.fill();
                    
                    // Ghost eyes
                    this.ctx.fillStyle = 'white';
                    this.ctx.beginPath();
                    this.ctx.arc(ghostX - 5, ghostY - 3, 4, 0, Math.PI * 2);
                    this.ctx.arc(ghostX + 5, ghostY - 3, 4, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = 'black';
                    this.ctx.beginPath();
                    this.ctx.arc(ghostX - 5, ghostY - 3, 2, 0, Math.PI * 2);
                    this.ctx.arc(ghostX + 5, ghostY - 3, 2, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    // Player name
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = 'bold 10px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(player.name, ghostX, ghostY - this.cellSize / 2 - 5);
                });
                
                // Update scoreboard
                this.updateScoreboard();
            }
            
            updateScoreboard() {
                const scoreBoard = document.getElementById('scoreBoard');
                scoreBoard.innerHTML = '<h3 style="margin: 0 0 10px 0; color: #ffd700;">Scores</h3>';
                
                const sortedPlayers = Array.from(this.players.values()).sort((a, b) => b.score - a.score);
                
                sortedPlayers.forEach(player => {
                    const scoreItem = document.createElement('div');
                    scoreItem.className = 'score-item';
                    scoreItem.innerHTML = `
                        <span>${player.name}</span>
                        <span style="color: #ffd700;">${player.score}</span>
                    `;
                    scoreBoard.appendChild(scoreItem);
                });
            }
            
            gameLoop() {
                if (!this.gameActive) return;
                
                this.update();
                this.render();
                
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        // Initialize game
        const game = new GhostVsPacmanGame();
        
        // Fix button event listeners
        document.getElementById('createRoomBtn').addEventListener('click', () => game.createRoom());
        document.getElementById('joinRoomBtn').addEventListener('click', () => game.showJoinInput());
        document.getElementById('joinBtn').addEventListener('click', () => game.joinRoom());
        
        // Add connection status indicator
        window.addEventListener('beforeunload', () => {
            if (game.channel) {
                game.channel.send({
                    type: 'broadcast',
                    event: 'player-update',
                    payload: { action: 'leave', player: { id: game.playerId } }
                });
            }
        });
